name: 部署算法博客到GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

env:
  NODE_VERSION: '18.x'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  # 构建工作
  build:
    name: 🏗️ 构建博客
    runs-on: ubuntu-latest
    steps:
      - name: 🛠️ 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ⚙️ 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package.json

      - name: 📦 安装依赖
        run: npm ci

      - name: 🔍 快速项目检查
        run: |
          echo "项目结构正常检查..."
          ls -la docs/ && echo "✅ docs目录存在"
          ls -la docs/.vitepress/ && echo "✅ vitepress配置存在"
          echo "找到Markdown文件: $(find docs -name "*.md" | wc -l) 个"

      - name: 🏗️ 构建VitePress博客
        run: |
          echo "开始构建VitePress..."
          npm run docs:build
          echo "构建完成"

      - name: ✅ 验证构建结果
        run: |
          if [ -d "docs/.vitepress/dist" ]; then
            echo "✅ 构建成功"
            echo "生成文件数: $(find docs/.vitepress/dist -type f | wc -l)"
            echo "构建大小: $(du -sh docs/.vitepress/dist | cut -f1)"
          else
            echo "❌ 构建失败: 未找到dist目录"
            echo "当前docs目录内容:"
            ls -la docs/
            exit 1
          fi

      - name: 📤 上传构建产物
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist

  # 部署工作
  deploy:
    name: 🚀 部署到GitHub Pages
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: 📲 部署到GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: 📝 记录部署信息
        run: |
          echo "🎉 部署完成!"
          echo "🌐 访问地址: ${{ steps.deployment.outputs.page_url }}"
          echo "⏰ 部署时间: $(date)"